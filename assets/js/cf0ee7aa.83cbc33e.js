"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[667],{6213:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>l,toc:()=>d});var i=n(4848),a=n(8453);const s={id:"tables",title:"Tables",sidebar_position:7},r="Tables",l={id:"paraflow/tables",title:"Tables",description:"Paraflow programs can define and manipulate application tables that are stored in a database, as well as small in-memory tables represented by a local variable. The language provides statements for creating, deleting, updating, and querying tables.",source:"@site/paranet/paraflow/tables.md",sourceDirName:"paraflow",slug:"/paraflow/tables",permalink:"/paraflow/tables",draft:!1,unlisted:!1,editUrl:"https://github.com/your-org/your-project/edit/main/paranet/paraflow/tables.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{id:"tables",title:"Tables",sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"Control Flow",permalink:"/paraflow/control_flow"},next:{title:"Bindings",permalink:"/paraflow/bindings"}},o={},d=[{value:"Queries",id:"queries",level:2},{value:"Joins",id:"joins",level:3},{value:"With Statement",id:"with-statement",level:2},{value:"Aggregation",id:"aggregation",level:3},{value:"Loop Statement",id:"loop-statement",level:2},{value:"Loop Body Variables",id:"loop-body-variables",level:3},{value:"Insert Statement",id:"insert-statement",level:2},{value:"Update Statement",id:"update-statement",level:2},{value:"Conditional Update",id:"conditional-update",level:3},{value:"Delete Statement",id:"delete-statement",level:2},{value:"Local Tables",id:"local-tables",level:2},{value:"Event Parameters",id:"event-parameters",level:3},{value:"Skill Request",id:"skill-request",level:3},{value:"Select Expressions",id:"select-expressions",level:3},{value:"Local Creation",id:"local-creation",level:3}];function c(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"tables",children:"Tables"})}),"\n",(0,i.jsx)(t.p,{children:"Paraflow programs can define and manipulate application tables that are stored in a database, as well as small in-memory tables represented by a local variable. The language provides statements for creating, deleting, updating, and querying tables."}),"\n",(0,i.jsx)(t.h2,{id:"queries",children:"Queries"}),"\n",(0,i.jsxs)(t.p,{children:["The query part of statements such as ",(0,i.jsx)(t.code,{children:"with"})," or ",(0,i.jsx)(t.code,{children:"foreach"})," describe a list of tables, constraints, and outputs as follows:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'<simple-query> := <select-clause> {"," <select-clause>}\n\n<select-clause> :=\n  <identifier> "(" <table-binding> {"," <table-binding>} ")"\n\n<table-binding> :=\n  <variable> |\n  <column> ":" <variable> |\n  <column> <relation> <expression>\n  <column> "~" <expression>\n\n<relation> := "==" | "<>" | "<" | "<=" | ">" | ">="\n'})}),"\n",(0,i.jsx)(t.p,{children:"For example:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"  order(id == $order_id, $date, total: $order_total)\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This query would match rows in the ",(0,i.jsx)(t.code,{children:"order"})," table that have an ",(0,i.jsx)(t.code,{children:"id"})," column equal to the value of the ",(0,i.jsx)(t.code,{children:"$order_id"})," variable. The ",(0,i.jsx)(t.code,{children:"$date"})," binding is a shorthand that binds the value of the column by the same name (without the dollar sign) to the variable ",(0,i.jsx)(t.code,{children:"$data"}),". The ",(0,i.jsx)(t.code,{children:"total"})," binding binds the value of the ",(0,i.jsx)(t.code,{children:"total"})," column to the variable ",(0,i.jsx)(t.code,{children:"$order_total"}),". For each row matching the constraint, the ",(0,i.jsx)(t.code,{children:"$date"})," and ",(0,i.jsx)(t.code,{children:"$order_total"})," variables will be assigned the values of the corresponding columns in the row before executing the body part of a statement containing the query."]}),"\n",(0,i.jsx)(t.h3,{id:"joins",children:"Joins"}),"\n",(0,i.jsx)(t.p,{children:"Queries may involve multiple tables, resulting in a join query. For example:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"  customer(id == $customer_id, $last_order), order(id == $last_order, $total)\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This query would find rows in the ",(0,i.jsx)(t.code,{children:"customer"})," table that match the ",(0,i.jsx)(t.code,{children:"id"})," constraint, and for each row, it matches rows in the ",(0,i.jsx)(t.code,{children:"order"})," table whose ",(0,i.jsx)(t.code,{children:"id"})," matches the current customer row\u2019s ",(0,i.jsx)(t.code,{children:"last_order"})," column. Outputs from the first table query are available to use as constraints in subsequent table queries, such as ",(0,i.jsx)(t.code,{children:"$last_order"})," in this example."]}),"\n",(0,i.jsx)(t.h2,{id:"with-statement",children:"With Statement"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"with"})," statement is used to fetch a single row or aggregate rows from a table."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'<with-statement> :=\n  "with" [ "unique" ] <simple-query> <*-stmt-block>\n  [ "else" <*-stmt-block> ";"\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Note that the ",(0,i.jsx)(t.code,{children:"with"})," statement may appear in events, rules, and tasks, which each have specific allowed statements, so ",(0,i.jsx)(t.code,{children:"*-stmt-block"})," corresponds to the appropriate block for whatever context it appears in, i.e., ",(0,i.jsx)(t.code,{children:"event-stmt-block"}),", ",(0,i.jsx)(t.code,{children:"rule-stmt-block"}),", or ",(0,i.jsx)(t.code,{children:"task-stmt-block"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"For example:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"with order(id == $order_id, $date, total: $order_total) {\n  if $order_total >= 1000 {\n    !AuthorizeLargeOrder(id -> $order_id);\n  }\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"with"})," statement is executed by querying the table for rows matching the simple query constraints. The values of the first matching row are used to initialize the output variables declared in the simple query. The block statement is then executed with these variables defined."]}),"\n",(0,i.jsxs)(t.p,{children:["If there are no matching rows and there is an ",(0,i.jsx)(t.code,{children:"else"})," part, then that block statement will be executed. It is an error if there are no matching rows and the statement does not include an ",(0,i.jsx)(t.code,{children:"else"})," part. It is also an error if the ",(0,i.jsx)(t.code,{children:"unique"})," keyword is present and more than one row matches."]}),"\n",(0,i.jsx)(t.h3,{id:"aggregation",children:"Aggregation"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"with"})," statement can also be used to aggregate columns in a table. For example:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"with order_item(order_id == $order_id, sum(amount): $order_total) {\n\u22ee\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This example returns the sum of the ",(0,i.jsx)(t.code,{children:"amount"})," column over all rows with a matching ",(0,i.jsx)(t.code,{children:"order_id"}),". Supported aggregate operators include: ",(0,i.jsx)(t.code,{children:"min"}),", ",(0,i.jsx)(t.code,{children:"max"}),", ",(0,i.jsx)(t.code,{children:"avg"}),", ",(0,i.jsx)(t.code,{children:"sum"}),", ",(0,i.jsx)(t.code,{children:"count"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"loop-statement",children:"Loop Statement"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"foreach"})," statement is used to iterate over any number of rows in a table."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'<loop-statement> :=\n  "foreach" [ "distinct" ] <simple-query> <*-stmt-block>\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Note that the ",(0,i.jsx)(t.code,{children:"foreach"})," statement may appear in events, rules, and tasks, which each have specific allowed statements, so ",(0,i.jsx)(t.code,{children:"*-stmt-block"})," corresponds to the appropriate block for whatever context it appears in, i.e., ",(0,i.jsx)(t.code,{children:"event-stmt-block"}),", ",(0,i.jsx)(t.code,{children:"rule-stmt-block"}),", or ",(0,i.jsx)(t.code,{children:"task-stmt-block"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"For example:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"foreach user_group(id == $target, $user) {\n  !SendReport($report, $user);\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This example creates a new ",(0,i.jsx)(t.code,{children:"!SendReport"})," goal for each user in the ",(0,i.jsx)(t.code,{children:"user_group"})," table with the matching ",(0,i.jsx)(t.code,{children:"id"})," in ",(0,i.jsx)(t.code,{children:"$target"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"loop-body-variables",children:"Loop Body Variables"}),"\n",(0,i.jsx)(t.p,{children:"Variables first defined within the loop body remain local to that statement block. However, if a variable is defined before the loop and is updated within the loop body, then it will retain its updated value after the loop. In the following example, the variable will have the total number of unsent messages outside the loop."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"let $unsent = 0;\nforeach message(from == $id, $sent) {\n  if not $sent {\n    let $unsent = $unsent + 1;\n  }\n}\nreturn { $unsent };\n"})}),"\n",(0,i.jsx)(t.h2,{id:"insert-statement",children:"Insert Statement"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"insert"})," statement is used to insert a new row into a table."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'<insert-expression> :=  "insert" <identifier> "(" <insert-binding> {"," <insert-binding>} ")"\n\n<insert-binding> :=\n  <variable> |\n  <column> ":" <expression>\n'})}),"\n",(0,i.jsx)(t.p,{children:"For example:"}),"\n",(0,i.jsx)(t.p,{children:"insert bug($title, open: 1);"}),"\n",(0,i.jsxs)(t.p,{children:["The arguments are the column name followed by an expression value for each column. Variable references are shorthand for providing the variable's value for the column with the same name, i.e., ",(0,i.jsx)(t.code,{children:"$target"})," in the example is shorthand for ",(0,i.jsx)(t.code,{children:"target: $target"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"insert"})," statement may also be used as the right-hand side of an assignment, in which case it returns the ",(0,i.jsx)(t.code,{children:"id"})," of the new row:"]}),"\n",(0,i.jsx)(t.p,{children:"let $row_id = insert bug($title, open: 1);"}),"\n",(0,i.jsx)(t.h2,{id:"update-statement",children:"Update Statement"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"update"})," statement is used to update rows of a table."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'<update-statement> :=\n  "update" <identifier> "(" <update-binding> {"," <update-binding>} ")"\n\n<update-binding> :=\n  <variable> |\n  <variable> "?" |\n  <column> ":" <expression> |\n  <column> ":" "incrBy" "(" <expression> ")" |\n  <column> ":" "decrBy" "(" <expression> ")" |\n  <column> ":" "append" "(" <expression> ")" |\n  <column> <relation> <expression>\n  <column> "~" <expression>\n'})}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"update"})," statement will update all rows that match the constraints in the ",(0,i.jsx)(t.code,{children:"update"})," binding, replacing values of columns with the expressions provided in the ",(0,i.jsx)(t.code,{children:"update"})," binding."]}),"\n",(0,i.jsxs)(t.p,{children:["The following predefined functions have special meaning in the ",(0,i.jsx)(t.code,{children:"update"})," binding:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"incrBy"}),": Adds the numeric value of the expression to the current value of the column."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"decrBy"}),": Subtracts the numeric value of the expression to the current value of the column."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"append"}),": Appends the string value of the expression to the current value of the column."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"conditional-update",children:"Conditional Update"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"update"})," statement also supports conditionally updating a column with the ",(0,i.jsx)(t.code,{children:'<variable> "?"'})," syntax. When this syntax is used, the column will only be updated if the variable is defined and not null. In the following example, the columns ",(0,i.jsx)(t.code,{children:"a"})," and ",(0,i.jsx)(t.code,{children:"b"})," are conditionally updated."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"event setOverride($id int, $a optional string, $b optional string) {\n  update item(id == $id, $a?, $b?);\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The column ",(0,i.jsx)(t.code,{children:"a"})," is only updated if the ",(0,i.jsx)(t.code,{children:"$a"})," parameter is provided and not null. Likewise, column ",(0,i.jsx)(t.code,{children:"b"})," is only updated if the ",(0,i.jsx)(t.code,{children:"$b"})," parameter is provided and not null. The behavior is equivalent to the following tedious code:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"event setOverride($id int, $a optional string, $b optional string) {\n  if $a and $b {\n    update item(id == $id, $a, $b);\n  } else if $a {\n    update item(id == $id, $a);\n  } else if $b {\n    update item(id == $id, $b);\n  }\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Note that this example is not equivalent to the following update, which would set the ",(0,i.jsx)(t.code,{children:"a/b"})," columns to null if ",(0,i.jsx)(t.code,{children:"a/b"})," were not provided."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"update item(id == $id, $a, $b);\n"})}),"\n",(0,i.jsx)(t.h2,{id:"delete-statement",children:"Delete Statement"}),"\n",(0,i.jsx)(t.p,{children:"This statement deletes rows from a table that match the given constraints."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'<delete-statement> :=\n  "delete" <identifier> "(" <delete-binding> {"," <delete-binding>} ")"\n\n<delete-binding> :=\n  <column> <relation> <expression>\n  <column> "~" <expression>\n'})}),"\n",(0,i.jsx)(t.h2,{id:"local-tables",children:"Local Tables"}),"\n",(0,i.jsx)(t.p,{children:"Local variables may represent in-memory tables and can be used in the same way as a database table. Local tables may appear as parameters to events, they may be returned from a PNCP skill request or RPC method, and they may be created locally. The following examples illustrate various uses of local tables."}),"\n",(0,i.jsx)(t.h3,{id:"event-parameters",children:"Event Parameters"}),"\n",(0,i.jsx)(t.p,{children:"This example illustrates how to use a table event parameter."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"event removeItems($items: table(sku string)) {\n  foreach $items($sku) {\n    delete products(sku == $sku);\n  }\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The event expects the ",(0,i.jsx)(t.code,{children:"items"})," input to be an array of objects having a ",(0,i.jsx)(t.code,{children:"sku"})," string field. The body loops over each row in the local table and deletes the corresponding row in a database table."]}),"\n",(0,i.jsx)(t.h3,{id:"skill-request",children:"Skill Request"}),"\n",(0,i.jsx)(t.p,{children:"A skill request may return arrays of data that can be bound to a local variable and used as a table. This example illustrates the use of a table returned by a skill request."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"task !FetchUpdates($last_fetch) is\n  pncp let {\n    transactions: $updates(timestamp, description, amount)\n  } = transactions/new_since(time -> $last_fetch) in {\n    foreach $updates($timestamp, $description, $amount) {\n      insert shadow($timestamp, $description, $amount);\n    }\n  }\n"})}),"\n",(0,i.jsxs)(t.p,{children:["In this example, there is an actor that maintains a store of transactions and a skill for querying transactions created since a given time. Its response has a ",(0,i.jsx)(t.code,{children:"transactions"})," field that is an array of transaction objects. Each transaction object has a ",(0,i.jsx)(t.code,{children:"timestamp"}),", ",(0,i.jsx)(t.code,{children:"description"}),", and ",(0,i.jsx)(t.code,{children:"amount"}),". The ",(0,i.jsx)(t.code,{children:"let"})," statement is used to capture the response ",(0,i.jsx)(t.code,{children:"transactions"})," into the local table variable ",(0,i.jsx)(t.code,{children:"$updates"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"The local table variable is used in the \u201cin\u201d block to update a local shadow database with the transactions in the local table."}),"\n",(0,i.jsx)(t.h3,{id:"select-expressions",children:"Select Expressions"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"select"})," expression can be used to select and transform data from a database table and store the resulting rows in a local table variable."]}),"\n",(0,i.jsxs)(t.p,{children:["One useful use case for creating a local table is to return tabular data from a skill request. Consider implementing the ",(0,i.jsx)(t.code,{children:"transactions/new_since"})," skill from the example in the previous section. That skill might be implemented as in:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"task !SendNewSince($time) {\n  let $transactions(timestamp, description, amount) = \n   select transaction_tbl(timestamp > $time, timestamp, description, amount);\n  pncp response($transactions);\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"local-creation",children:"Local Creation"}),"\n",(0,i.jsx)(t.p,{children:"Another way to create a local table is from scratch. This is one way to easily filter and transform data before using it. The following example illustrates local table creation."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"event getActive($threshold double) {\n  let $active(*) = table();\n  foreach location_tbl($id, $activity, $easting, $northing) {\n    if $activity > $threshold {\n      let { $lat, $lon } = ToGPS($easting, $northing);\n      insert $active($id, $lat, $lon);\n    }\n  }\n  return { $active };\n}\n"})})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>l});var i=n(6540);const a={},s=i.createContext(a);function r(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(s.Provider,{value:t},e.children)}}}]);