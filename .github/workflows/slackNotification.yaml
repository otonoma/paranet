name: Slack Notification

on:
  push:
    branches:
      - feature/DEV-313
  workflow_run:
    workflows: ["Staging Release", "Production Release"]
    types:
      - completed

permissions:
  actions: read
  contents: read

jobs:
  slack-notification:
    name: Notify Slack
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Determine Release Type
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "RELEASE_TYPE=feature-test" >> $GITHUB_ENV
          elif [[ "${{ github.event.workflow_run.name }}" == "Staging Release" ]]; then
            echo "RELEASE_TYPE=staging" >> $GITHUB_ENV
          else
            echo "RELEASE_TYPE=production" >> $GITHUB_ENV
          fi

      - name: Set Date and Version
        id: set_version
        run: |
          DATE_TAG=$(date +'%Y.%m.%d')
          if [[ "$RELEASE_TYPE" == "staging" ]]; then
            VERSION="staging-${DATE_TAG}"
          elif [[ "$RELEASE_TYPE" == "production" ]]; then
            VERSION="prod-${DATE_TAG}"
          else
            VERSION="test-${DATE_TAG}"
          fi
          echo "DATE_TAG=$DATE_TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Set Hardcoded Image Artifacts
        id: set_images
        run: |
          IMAGES=$(cat <<EOF
          • ghcr.io/otonoma/paracord/paracord:${{ env.VERSION }}
          • ghcr.io/otonoma/paranet-broker/paranet-broker:${{ env.VERSION }}
          • ghcr.io/otonoma/paranet-broker/paranet-service:${{ env.VERSION }}
          • ghcr.io/otonoma/paranet-broker/paranet-broker-sim:${{ env.VERSION }}
          • ghcr.io/otonoma/paraflow/paraflow:${{ env.VERSION }}
          • ghcr.io/otonoma/paraflow/paraflow-sim:${{ env.VERSION }}
          • ghcr.io/otonoma/paraflow/debugger:${{ env.VERSION }}
          EOF
          )
          echo "IMAGES<<EOF" >> $GITHUB_ENV
          echo "$IMAGES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: |
                    :rocket: *New ${{ env.RELEASE_TYPE }} Release!* :rocket:

                    :calendar: *Date:* ${{ env.DATE_TAG }}
                    :package: *Version:* ${{ env.VERSION }}
                    :file_folder: *Published Artifacts:* 
                    ```
                    ${{ env.IMAGES }}
                    ```
                    :label: *Environment:* ${{ env.RELEASE_TYPE == 'production' && 'PROD' || env.RELEASE_TYPE == 'staging' && 'STG' || 'FEATURE TEST' }}
